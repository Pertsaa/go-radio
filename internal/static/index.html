<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Go Radio</title>

  <link rel="icon" href="favicon.png" />
  <link rel="stylesheet" href="index.css" />

  <script src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1" type="module"></script>
</head>

<body class="text-sm bg-neutral-950 text-slate-50 select-none">
  <main class="flex flex-col">
    <div
      class="fixed flex items-center justify-between h-[64px] overflow-hidden gap-2 px-6 top-0 left-0 right-0 bg-neutral-950 border-b border-neutral-800">
      <div class="flex gap-2 items-center whitespace-nowrap">
        <img src="favicon.png" width="64" height="32" />
        <h1 class="font-semibold text-base leading-16">Go Radio</h1>
      </div>
    </div>

    <div class="mt-[64px] p-12">
      <ul id="channel-list" class="flex flex-col gap-2"></ul>
    </div>

    <audio id="audio-player" preload="auto">
      Your browser does not support the audio element.
    </audio>
  </main>
</body>

<template id="channel-list-item">
  <li
    class="group data-active:border-green-500 flex items-center gap-4 data-active:bg-neutral-900 data-active:text-green-500 p-6 text-left rounded border border-neutral-800 bg-neutral-950 transition-all">
    <!-- play button -->
    <button
      class="size-8 text-white cursor-pointer transition-all ease-in-out flex items-center justify-center rounded-full hover:scale-125 duration-500 group-data-active:hidden">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="lucide lucide-play-icon lucide-play">
        <path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z" />
      </svg>
    </button>

    <!-- pause button -->
    <button
      class="size-8 text-white cursor-pointer transition-all ease-in-out items-center justify-center rounded-full hover:scale-125 duration-500 hidden group-data-active:flex group-data-active:text-green-500">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="lucide lucide-pause-icon lucide-pause">
        <rect x="14" y="3" width="5" height="18" rx="1" />
        <rect x="5" y="3" width="5" height="18" rx="1" />
      </svg>
    </button>

    <!-- channel name -->
    <h2 class="font-semibold"></h2>
  </li>
</template>

</html>

<script>
  let activeChannelId;

  const channelList = document.getElementById("channel-list");
  const channelListItem = document.getElementById("channel-list-item");
  const audioPlayer = document.getElementById("audio-player");

  function handlePlayChannel(channelId) {
    if (activeChannelId === channelId) {
      return;
    }

    audioPlayer.pause();
    audioPlayer.src = "";

    const url = `http://localhost:8080/radio/channels/${channelId}/stream`;
    audioPlayer.src = url;

    audioPlayer.load();
    audioPlayer
      .play()
      .then(() => console.log(`playing channel: ${channelId}`))
      .catch((error) => console.error("Playback error:", error));

    document
      .querySelectorAll("li")
      .forEach((b) => b.removeAttribute("data-active"));
    document.getElementById(channelId).setAttribute("data-active", true);

    activeChannelId = channelId;
  }

  function handleStop() {
    audioPlayer.pause()
    audioPlayer.src = ""
    document
      .querySelectorAll("li")
      .forEach((b) => b.removeAttribute("data-active"));
    activeChannelId = undefined
  }

  async function init() {
    const response = await fetch("http://localhost:8080/radio/channels");
    const channels = await response.json();

    for (const channel of channels) {
      const node = channelListItem.content.cloneNode(true);
      const li = node.querySelectorAll("li")[0];
      const h2 = node.querySelectorAll("h2")[0];
      const playButton = node.querySelectorAll("button")[0];
      const pauseButton = node.querySelectorAll("button")[1];
      li.id = channel.id;
      h2.textContent = channel.name;
      playButton.addEventListener("click", () => handlePlayChannel(channel.id));
      pauseButton.addEventListener("click", handleStop)
      channelList.appendChild(node);
    }
  }

  init();
</script>